pipeline {
  agent {
    docker {
      image 'stateoftheartio/qt6:6.7-mingw-aqt'
      alwaysPull true
    }
  }
  options {
    skipDefaultCheckout()
  }
  environment {
    WINEPREFIX = "${env.WORKSPACE}/.wine"
    BUILD_DIR  = 'build-windows'
    BIN_DIR    = 'build-windows/build'
    DEPLOY_DIR = 'build-windows/MeshViewer'
    ZIP_PATH   = 'build-windows/MeshViewer.zip'
    REPO       = 'yanisseF69/MeshViewer'
    TAG        = "v${env.BUILD_NUMBER}"
    NAME       = "MeshViewer v${env.BUILD_NUMBER}"
    CMAKE_TRY_COMPILE_TARGET_TYPE = 'STATIC_LIBRARY'
  }
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Prepare Wine prefix') {
      steps {
        sh 'mkdir -p "$WINEPREFIX"'
      }
    }

    stage('Configure & Build') {
      steps {
        sh '''
          set -e
          mkdir -p "$BIN_DIR"
          qt-cmake . -G Ninja -B "$BIN_DIR"
          cmake --build "$BIN_DIR"
        '''
      }
    }

    stage('Deploy Qt runtime') {
      steps {
        sh '''
          set -e
          mkdir -p "$DEPLOY_DIR"
          windeployqt --compiler-runtime --qmldir . \
            --dir "$DEPLOY_DIR" --libdir "$DEPLOY_DIR" --plugindir "$DEPLOY_DIR" \
            "$BIN_DIR/MeshViewer.exe"
          cp "$BIN_DIR/MeshViewer.exe" "$DEPLOY_DIR/"
        '''
      }
    }

    stage('Package ZIP (python)') {
      steps {
        sh '''
          set -e
          python3 - <<'PY'
import os, zipfile
zip_path = os.environ["ZIP_PATH"]
deploy_dir = os.environ["DEPLOY_DIR"]
base = os.path.dirname(deploy_dir)
with zipfile.ZipFile(zip_path, 'w', compression=zipfile.ZIP_DEFLATED) as z:
    for root, _, files in os.walk(deploy_dir):
        for f in files:
            full = os.path.join(root, f)
            rel  = os.path.relpath(full, base)
            z.write(full, rel)
print("Created", zip_path)
PY
        '''
      }
    }

    stage('Archive') {
      steps {
        archiveArtifacts artifacts: 'build-windows/MeshViewer/**', fingerprint: true
        archiveArtifacts artifacts: 'build-windows/MeshViewer.zip', fingerprint: true
      }
    }
  }
}
